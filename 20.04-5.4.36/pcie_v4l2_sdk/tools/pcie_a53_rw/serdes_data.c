#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <byteswap.h>
#include <string.h>
#include <errno.h>
#include <signal.h>
#include <fcntl.h>
#include <ctype.h>
#include <termios.h>

#include <sys/types.h>
#include <sys/mman.h>
#include <sys/time.h>

#include "element_process.h"
//#include "serdes_data_raw.c"

DATA_ELEMENT max9296_96705_array[] = {
	{0x90, 0x0313, 0x40, 0x10, 5},	 // disable MIPI output
	{0x90, 0x0006, 0x9F, 0x10, 5},	 // config linkA as GMSL1 mode
	{0x90, 0x0B06, 0xEF, 0x10, 5},	 // config linkA as high-HIM mode
	{0x90, 0x0B0D, 0x80, 0x10, 5},	 // enable linkA local-ack
	{0x90, 0x0F00, 0x01, 0x10, 100}, // enable linkA
	{0x80, 0x04, 0x47, 0x08, 100},	 // config link mode
	{0x80, 0x07, 0x84, 0x08, 5},	 // config HVEN=1 DBL=1 BWS=0
	{0x90, 0x0B07, 0x84, 0x10, 5},	 // config linkA HVEN=1 DBL=1 BWS=0
	{0x90, 0x0B0F, 0x01, 0x10, 5},	 // config linkA DE_EN=0
	{0x90, 0x0332, 0xf0, 0x10, 5},	 // enable phy0 ~ phy4
	{0x90, 0x0313, 0x40, 0x10, 5},	 // Pipe X software defined BPP (8Bit)
	{0x90, 0x0314, 0x00, 0x10, 5},	 // Pipe X software defined virtual-channel = 0
	{0x90, 0x0316, 0x5e, 0x10, 5},	 // Pipe X software defined data-type (YUV422 8Bit)
	{0x90, 0x0317, 0x0e, 0x10, 5},	 // Pipe X software defined data-type (YUV422 8Bit)
	{0x90, 0x031d, 0xef, 0x10, 5},	 // Pipe X software defined BPP,data-type,virtual-channel
	{0x90, 0x040b, 0x1f, 0x10, 5},	 // Pipe X MAP enable - five
	{0x90, 0x040d, 0x1e, 0x10, 5},	 // PIPE X mapping src (YUV422 8Bit)
	{0x90, 0x040e, 0x1e, 0x10, 5},	 // PIPE X YUV422 8Bit mapping
	{0x90, 0x040f, 0x00, 0x10, 5},	 // PIPE X FS mapping
	{0x90, 0x0410, 0x00, 0x10, 5},	 // PIPE X FS mapping
	{0x90, 0x0411, 0x01, 0x10, 5},	 // PIPE X FE mapping
	{0x90, 0x0412, 0x01, 0x10, 5},	 // PIPE X FE mapping
	{0x90, 0x0413, 0x02, 0x10, 5},	 // PIPE X LS mapping
	{0x90, 0x0414, 0x02, 0x10, 5},	 // PIPE X LS mapping
	{0x90, 0x0415, 0x03, 0x10, 5},	 // PIPE X LE mapping
	{0x90, 0x0416, 0x03, 0x10, 5},	 // PIPE X LE mapping
	{0x90, 0x042d, 0x55, 0x10, 5},	 // Pipe X To MIPI port A
	{0x90, 0x042e, 0x01, 0x10, 5},	 // Pipe X To MIPI port A
	{0x90, 0x0003, 0x40, 0x10, 5},	 //
	{0x90, 0x0B08, 0x20, 0x10, 5},	 // GPI-to-GPO
	{0x90, 0x0322, 0x10, 0x10, 5},	 // enable muxed mode 1 support
	{0x90, 0x0320, 0x2C, 0x10, 5},	 // MIPI Port A speed : 1200Mbps
	{0x80, 0x04, 0x87, 0x08, 5},	 // video link mode
};

DATA_ELEMENT max9296_9295_array[] = {
    // {0x80, 0x0010, 0x91, 0x10, 200}, // max9295 reset
    // {0x90, 0x0010, 0x91, 0x10, 200}, // max9296 reset
	{0x90, 0x0313, 0x00, 0x10, 5},	 // disable MIPI output
	{0x80, 0x02BE, 0x00, 0x10, 200}, // camera reset
	{0x80, 0x0057, 0x12, 0x10, 5},	 // swap Y & Z
	{0x80, 0x005B, 0x11, 0x10, 5},	 // swap Y & Z
	{0x80, 0x0318, 0x5e, 0x10, 5},	 // yuv422
	{0x80, 0x02d3, 0x04, 0x10, 5},	 // mfp7 config
	{0x80, 0x02D5, 0x07, 0x10, 5},	 // mfp7 config
	{0x80, 0x02d6, 0x04, 0x10, 5},	 // mfp8 config
	{0x80, 0x02D8, 0x07, 0x10, 5},	 // mfp8 config
	{0x90, 0x0003, 0x40, 0x10, 5},// GPIO enable
	{0x90, 0x02c2, 0x83, 0x10, 5}, //
	{0x90, 0x02c3, 0xA7, 0x10, 5}, //
	{0x90, 0x0320, 0x2F, 0x10, 5}, // mipi 1200Mbps
	//{0x90, 0x0010, 0x21, 0x10, 100}, // oneshot reset
	{0x80, 0x02BE, 0x10, 0x10, 100} // camera reset release
};

DATA_ELEMENT max9296_9295_isx031_array[] = {
    // {0x80, 0x0010, 0x91, 0x10, 200}, // max9295 reset
    // {0x90, 0x0010, 0x91, 0x10, 200}, // max9296 reset
	{0x90, 0x0313, 0x00, 0x10, 5},	 // disable MIPI output
	{0x80, 0x02BE, 0x00, 0x10, 200}, // camera reset
	{0x80, 0x0057, 0x12, 0x10, 5},	 // swap Y & Z
	{0x80, 0x005B, 0x11, 0x10, 5},	 // swap Y & Z
	{0x80, 0x0318, 0x5e, 0x10, 5},	 // yuv422
	{0x80, 0x02d3, 0x04, 0x10, 5},	 // mfp7 config
	{0x80, 0x02D5, 0x07, 0x10, 5},	 // mfp7 config
	{0x80, 0x02d6, 0x04, 0x10, 5},	 // mfp8 config
	{0x80, 0x02D8, 0x07, 0x10, 5},	 // mfp8 config
	{0x90, 0x0003, 0x40, 0x10, 5},// GPIO enable
	{0x90, 0x02c2, 0x83, 0x10, 5}, //
	{0x90, 0x02c3, 0xA7, 0x10, 5}, //
	{0x90, 0x0320, 0x2F, 0x10, 5}, // mipi 1200Mbps
	//{0x90, 0x0010, 0x21, 0x10, 100}, // oneshot reset
	{0x80, 0x02BE, 0x10, 0x10, 500}, // camera reset release
    {0x34, 0x8a01, 0x00, 0x10, 100}, //
    {0x34, 0x8af0, 0x1, 0x10, 100}, //
    {0x34, 0xbf14, 0x1, 0x10, 130} ,//
    {0x34, 0x8a01, 0x80, 0x10, 100} //
};


DATA_ELEMENT max9296_96717F_array[] = {

	{0x90, 0x0313, 0x00, 0x10, 5}, // disable MIPI output
	{0x90, 0x0001, 0x01, 0x10, 400}, // 3g
	{0x80, 0x02BE, 0x00, 0x10, 200}, // camera reset
	{0x80, 0x0057, 0x12, 0x10, 5}, // swap Y & Z
	{0x80, 0x005B, 0x11, 0x10, 5}, // swap Y & Z
	{0x80, 0x0318, 0x5E, 0x10, 5}, // yuv422
	{0x80, 0x02d3, 0x04, 0x10, 5}, // mfp7 config
	{0x80, 0x02D5, 0x07, 0x10, 5}, // mfp7 config
	{0x80, 0x02d6, 0x04, 0x10, 5}, // mfp8 config
	{0x80, 0x02D8, 0x07, 0x10, 5}, // mfp8 config
	{0x90, 0x0003, 0x40, 0x10, 5}, // GPIO enable
	{0x90, 0x02c2, 0x83, 0x10, 5}, //
	{0x90, 0x02c3, 0xA7, 0x10, 5}, //
	{0x90, 0x0320, 0x2C, 0x10, 5}, // mipi 1200Mbps
//	{0x90, 0x325, 0x80, 0x10, 100},	 //
	{0x80, 0x02BE, 0x10, 0x10, 100} // camera reset release
//	{0x80, 0x0308, 0x66, 0x10, 100}, // mipi input enable
//	{0x90, 0x0313, 0x02, 0x10, 100}, // mipi output enable
};



DATA_ELEMENT  max9296_9295_anc_array[] = {
    {0x80, 0x0010, 0x91, 0x10, 500}, //reset max 9295 all registers
    {0x90, 0x0010, 0x91, 0x10, 500}, //reset max 9296 all registers
	{0x80, 0x02BE, 0x00, 0x10, 200}, // camera reset
    {0x90, 0x0313, 0x00, 0x10, 500},	 // disable MIPI output
	{0x80, 0x0308, 0x63, 0x10, 100},    // enable port-b; pipe x and y to port-b
	{0x80, 0x0311, 0x30, 0x10, 5},//start video pipe x & y from csi port-b
	{0x80, 0x0002, 0x33, 0x10, 5}, // Video transmit enable for pipe X & Y
	{0x80, 0x0314, 0x5E, 0x10, 5}, 	// video pipe X : YUV422
	{0x80, 0x0316, 0x52, 0x10, 5}, // video pipe Y : EBD
	{0x90, 0x01D9, 0x39, 0x10, 5}, //disable VS output
	{0x90, 0x040b, 0x01, 0x10, 5},
	{0x90, 0x040d, 0x1e, 0x10, 5},
	{0x90, 0x040e, 0x1e, 0x10, 5},
	{0x90, 0x042d, 0x15, 0x10, 5},
	{0x90, 0x044B, 0x07, 0x10, 5},
	{0x90, 0x046D, 0x15, 0x10, 5},
	{0x90, 0x044D, 0x12, 0x10, 5},
	{0x90, 0x044E, 0x12, 0x10, 5},
	{0x90, 0x044F, 0x00, 0x10, 5},
	{0x90, 0x0450, 0x00, 0x10, 5},
	{0x90, 0x0451, 0x01, 0x10, 5},
	{0x90, 0x0452, 0x01, 0x10, 5},
	{0x90, 0x0320, 0x2F, 0x10, 5},  //mipi 1500Mbps
	{0x80, 0x02d3, 0x04, 0x10, 5},	 // mfp7 config
	{0x80, 0x02D5, 0x07, 0x10, 5},	 // mfp7 config
	{0x80, 0x02d6, 0x04, 0x10, 5},	 // mfp8 config
	{0x80, 0x02D8, 0x07, 0x10, 5},	 // mfp8 config
	{0x90, 0x0003, 0x40, 0x10, 5},
	{0x90, 0x02c2, 0x83, 0x10, 5}, //
	{0x90, 0x02c3, 0xA7, 0x10, 5}, //
	{0x90, 0x0010, 0x21, 0x10, 100}, // oneshot reset
	{0x80, 0x02BE, 0x10, 0x10, 100}, // camera reset release
};

DATA_ELEMENT  max9296_96717F_anc_array[] = {
    {0x90, 0x0313, 0x00, 0x10, 5},	 // disable MIPI output
	{0x90, 0x0001, 0x01, 0x10, 400}, // 3g
	{0x80, 0x02BE, 0x00, 0x10, 200}, // camera reset
	//{0x80, 0x0057, 0x12, 0x10, 5},	 // swap Y & Z
	//{0x80, 0x005B, 0x11, 0x10, 5},	 // swap Y & Z
	//{0x80, 0x0318, 0x0, 0x10, 5},	 // yuv422
	{0x90, 0x0010, 0x91, 0x10, 500}, //reset max 9296 all registers
	{0x80, 0x0308, 0x63, 0x10, 100},
	{0x80, 0x0311, 0x30, 0x10, 5},//start video pipe x & y from csi port BPP
	{0x80, 0x0002, 0x33, 0x10, 5}, // Video transmit enable for port X & Y
	{0x80, 0x0314, 0x5E, 0x10, 5}, 	// video pipe X : YUV422
	{0x80, 0x0316, 0x52, 0x10, 5}, // video pipe Y : EBD
	{0x90, 0x01D9, 0x39, 0x10, 5}, //disable VS output
	{0x90, 0x040b, 0x01, 0x10, 5},
	{0x90, 0x040d, 0x1e, 0x10, 5},
	{0x90, 0x040e, 0x1e, 0x10, 5},
	{0x90, 0x042d, 0x15, 0x10, 5},
	{0x90, 0x044B, 0x07, 0x10, 5},
	{0x90, 0x046D, 0x15, 0x10, 5},
	{0x90, 0x044D, 0x12, 0x10, 5},
	{0x90, 0x044E, 0x12, 0x10, 5},
	{0x90, 0x044F, 0x00, 0x10, 5},
	{0x90, 0x0450, 0x00, 0x10, 5},
	{0x90, 0x0451, 0x01, 0x10, 5},
	{0x90, 0x0452, 0x01, 0x10, 5},
	{0x90, 0x0320, 0x28, 0x10, 5},
	//	{0x90, 0x10, 0x21, 0x10, 5}, // max9296 oneshot reset
	{0x80, 0x02d3, 0x04, 0x10, 5},	 // mfp7 config
	{0x80, 0x02D5, 0x07, 0x10, 5},	 // mfp7 config
	{0x80, 0x02d6, 0x04, 0x10, 5},	 // mfp8 config
	{0x80, 0x02D8, 0x07, 0x10, 5},	 // mfp8 config
	{0x90, 0x0003, 0x40, 0x10, 5},
	{0x90, 0x02c2, 0x83, 0x10, 5}, //
	{0x90, 0x02c3, 0xA7, 0x10, 5}, //
	{0x90, 0x0320, 0x2C, 0x10, 5}, // mipi 1200Mbps
	//{0x90, 0x0010, 0x21, 0x10, 100}, // oneshot reset
	{0x80, 0x02BE, 0x10, 0x10, 100}, // camera reset release
};

ELE_INFO ele_info[] = {
	{max9296_96705_array, sizeof(max9296_96705_array) / sizeof(DATA_ELEMENT)},
	{max9296_9295_array, sizeof(max9296_9295_array) / sizeof(DATA_ELEMENT)},
	{max9296_96717F_array, sizeof(max9296_96717F_array) / sizeof(DATA_ELEMENT)},
    {max9296_9295_anc_array, sizeof(max9296_9295_anc_array) / sizeof(DATA_ELEMENT)},
	{max9296_96717F_anc_array, sizeof(max9296_96717F_anc_array) / sizeof(DATA_ELEMENT)},   
    //{max9296_9295_raw_array, sizeof(max9296_9295_raw_array) / sizeof(DATA_ELEMENT)},//5
    //{max_X8B_raw_array, sizeof(max_X8B_raw_array) / sizeof(DATA_ELEMENT)},//6
    //{max9296_9295_ar0233_raw_array, sizeof(max9296_9295_ar0233_raw_array) / sizeof(DATA_ELEMENT)},//7
    //{max9296_9295_ar0820_raw_array, sizeof(max9296_9295_ar0820_raw_array) / sizeof(DATA_ELEMENT)},//8
    //{max9296_9295_imax390_raw_array, sizeof(max9296_9295_imax390_raw_array) / sizeof(DATA_ELEMENT)},//9
    //{max9296_9295_imax490_raw_array, sizeof(max9296_9295_imax490_raw_array) / sizeof(DATA_ELEMENT)},//10
    //{max9296_9295_isx031_array, sizeof(max9296_9295_isx031_array) / sizeof(DATA_ELEMENT)}//11 fish eye camera
}; 

//ELE_INFO ele_info_raw[];


void serdes_channel_init(void *BaseAddress, uint32_t channel, uint32_t index)
{
    if(index < 100)
    {
        element_channel_process(BaseAddress, channel + 1, ele_info[index].pDATA, ele_info[index].ele_size);
    }
    else
    {
        //element_channel_process(BaseAddress, channel + 1, ele_info_raw[index-100].pDATA, ele_info_raw[index-100].ele_size);
        serdes_channel_init_raw(BaseAddress, channel, index);
    }
	printf("Serdes CH %d Done!\r\n", channel);
}
